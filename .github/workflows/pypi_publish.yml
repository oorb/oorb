name: Build and upload release to PyPI

on:
  release:
    types:
      - published

jobs:
  oorb_data:
    uses: ./.github/workflows/oorb_data.yml

  wheels:
    name: "Build wheels: ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm, macos-15-intel, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup python for cibuildwheel
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Set environment
        run: |
          echo "MACOSX_DEPLOYMENT_TARGET=15.0" >> "$GITHUB_ENV"

      - uses: fortran-lang/setup-fortran@v1
        id: setup-fortran
        with:
          compiler: gcc
          version: latest

      # see pyproject.toml for cibuildwheel configuration
      - name: Build wheels
        uses: pypa/cibuildwheel@v3.3.0
        with:
          output-dir: wheelhouse

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: wheelhouse/*.whl

  test_wheels:
    name: "Test wheels: ${{ matrix.os }}/py${{ matrix.pyversion }}"
    runs-on: ${{ matrix.os }}
    needs: [wheels, oorb_data]

    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm, macos-15-intel, macos-latest]
        pyversion: ["3.10", "3.11", "3.12", "3.13", "3.14"]

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.pyversion }}

      # checkout code specifically for python/pyoorb/test.py
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get wheels
        uses: actions/download-artifact@v5
        with:
          name: wheels-${{ matrix.os }}
          path: /tmp/artifacts/wheels

      - name: Restore cached ephemeris data
        uses: actions/cache/restore@v4
        with:
          key: oorb_data
          path: /tmp/cache/oorb_data
          enableCrossOsArchive: true
          fail-on-cache-miss: true

      - name: Set environment
        run: |
          echo "OORB_DATA=/tmp/cache/oorb_data" >> "$GITHUB_ENV"

      - name: Install pyoorb from wheel
        # First, install with --no-index to make sure we don't hit up PyPI and
        # only use the local wheel. Use --no-deps, because we don't have a local
        # copy of any dependencies. Once we are sure the local wheel works,
        # install dependencies by repeating the command, but this time allowing
        # the index and deps.
        run: |
          pip install --no-index --no-deps --find-links /tmp/artifacts/wheels pyoorb
          pip install --find-links /tmp/artifacts/wheels pyoorb

      - name: Run tests
        run: |
          python -c "import pyoorb; print('Import success.')"
          python python/pyoorb/test.py

  # Make a plain source distribution with nothing precompiled.
  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Build source distribution
        run: |
          pip install -U build
          python3 -m build --sdist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: source-distribution
          path: dist/*.tar.gz

  # restore wheels and source distribution to dist/ and publish
  upload_all:
    name: Upload release to PyPI
    runs-on: ubuntu-latest

    needs:
      - build_sdist
      - test_wheels

    if: github.event_name == 'release' && github.event.action == 'published'

    permissions:
      id-token: write

    steps:
      - name: Get artifacts
        uses: actions/download-artifact@v5
        with:
          merge-multiple: true
          path: dist/

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        # delete after testing:
        with:
          verbose: true
          repository-url: https://test.pypi.org/legacy/
